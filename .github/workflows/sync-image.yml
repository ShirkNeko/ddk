name: sync-image-to-ghcr

on:
  workflow_dispatch:
    inputs:
      date:
        description: "可选：附加版本日期（例如 20251016），将额外同步 tag-<date>"
        required: false
        default: ""

jobs:
  sync:
    name: Sync images from CNB to GHCR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends skopeo jq

      - name: Login to GHCR
        env:
          GHCR_USER: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          echo "$GHCR_TOKEN" | skopeo login ghcr.io --username "$GHCR_USER" --password-stdin

      - name: Sync images to GHCR only
        run: |
          set -euo pipefail
          src_key="cnb"
          echo "使用源: ${src_key}"
          date_input='${{ github.event.inputs.date }}'
          [ -n "$date_input" ] && echo "使用日期后缀: $date_input" || echo "未指定日期后缀"

          # 读取映射
          ghcr_repo=$(jq -r '.registry["ddk"].github' mapping.json)
          cnb_repo=$(jq -r '.registry["ddk"].cnb' mapping.json)
          ghcr_clang_repo=$(jq -r '.registry["ddk-clang"].github' mapping.json)
          cnb_clang_repo=$(jq -r '.registry["ddk-clang"].cnb' mapping.json)

          echo "[INFO] 从 mapping.json 收集 ddk 标签"
          for tag in $(jq -r '.android[].name' mapping.json); do
            echo "=== 同步 ddk:$tag ==="
            src="$cnb_repo:$tag"
            dst="$ghcr_repo:$tag"
            echo "源: $src"
            echo "→ GHCR: $dst"
            skopeo copy --all docker://"$src" docker://"$dst"

            if [ -n "$date_input" ]; then
              dst_date="$ghcr_repo:${tag}-$date_input"
              echo "→ GHCR (date): $dst_date"
              skopeo copy --all docker://"$src" docker://"$dst_date"
            fi
          done

          echo "[INFO] 从 mapping.json 收集 ddk-clang 标签"
          for tag in $(jq -r '.clang[].version' mapping.json); do
            echo "=== 同步 ddk-clang:$tag ==="
            src="$cnb_clang_repo:$tag"
            dst="$ghcr_clang_repo:$tag"
            echo "源: $src"
            echo "→ GHCR: $dst"
            skopeo copy --all docker://"$src" docker://"$dst"

            if [ -n "$date_input" ]; then
              dst_date="$ghcr_clang_repo:${tag}-$date_input"
              echo "→ GHCR (date): $dst_date"
              skopeo copy --all docker://"$src" docker://"$dst_date"
            fi
          done

          echo "同步完成：源 → GHCR" | tee -a $GITHUB_STEP_SUMMARY
